#/bin/bash

# usage: ../scripts/mk-welcome minWidth maxWidth minHeight maxHeight identifier
#
# Creates a folder "identifier" with temporary data and an output file
# "identifier.pdf". Any existing files will be overwritten.

minWidth=$1
maxWidth=$2
minHeight=$3
maxHeight=$4
identifier=$5

# number of pixel rows on each width-measure page that are
# occupied by static stuff such as instructions
STATIC_HEIGHT=110

# number of pixel columns on each height-measure page that are
# occupied by static stuff such as instructions
STATIC_WIDTH=70

LINE_HEIGHT=40

mkdir $identifier 2>/dev/null
cd $identifier

echo "Creating $identifier.pdf..."

# === Make test stripes to measure width ===================================

innerHeight=$((100*$minWidth*$minHeight/$maxWidth/105-7))
# (remove 5% to be on the save side and subtract 7 because minWidth
# may be replaced by something a little bit smaller below.)

widthStripesPerPage=$((($innerHeight-$STATIC_HEIGHT)/$LINE_HEIGHT))
widthPages=$((($maxWidth-$minWidth)/$widthStripesPerPage+1))
widthStripes=$(($widthPages*$widthStripesPerPage))
newMinWidth=$(($minWidth-($widthStripes+$minWidth-$maxWidth-1)/2))

../../scripts/mk-turnpage-w-svg $newMinWidth $innerHeight | rsvg-convert -f pdf -o turnpage-w.pdf

pages="../../static-pages/welcome.pdf ../../static-pages/instructions-width.pdf turnpage-w.pdf"
lowWidth=$newMinWidth
for i in `seq -w $widthPages`; do
	../../scripts/mk-width-measure-page $lowWidth $widthStripesPerPage $i $widthPages $innerHeight $identifier-width$i
	pages="$pages $identifier-width$i.pdf turnpage-w.pdf"
	lowWidth=$(($lowWidth+$widthStripesPerPage))
done


# === Make test stripes to measure width ===================================

innerWidth=$((100*$minWidth*$minHeight/$maxHeight/105-7))
# (remove 5% to be on the save side and subtract 7 because minHeight
# may be replaced by something a little bit smaller below.)

heightStripesPerPage=$((($innerWidth-$STATIC_WIDTH)/$LINE_HEIGHT))
heightPages=$((($maxHeight-$minHeight)/$heightStripesPerPage+1))
heightStripes=$(($heightPages*$heightStripesPerPage))
newMinHeight=$(($minHeight-($heightStripes+$minHeight-$maxHeight-1)/2))

../../scripts/mk-turnpage-h-svg $innerWidth $newMinHeight | rsvg-convert -f pdf -o turnpage-h.pdf

pages="$pages ../../static-pages/instructions-height.pdf turnpage-h.pdf"
lowHeight=$newMinHeight
for i in `seq -w $heightPages`; do
	../../scripts/mk-height-measure-page $lowHeight $heightStripesPerPage $i $heightPages $innerWidth $identifier-height$i
	pages="$pages $identifier-height$i.pdf turnpage-h.pdf"
	lowHeight=$(($lowHeight+$heightStripesPerPage))
done


# === Stitch it all together ===============================================

pages="$pages ../../static-pages/end.pdf ../../static-pages/copyright.pdf"
pdftk $pages cat output ../$identifier.pdf